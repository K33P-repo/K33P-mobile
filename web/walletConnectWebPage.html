<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cardano Connect WebView</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; min-height: 100vh; background-color: #1a1a1a; display: flex; justify-content: center; align-items: center; }
    #root { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@cardano-foundation/cardano-connect-with-wallet@0.2.14/dist/index.umd.js"></script>

  <script type="text/babel">
    const { useCardano, ConnectWalletList } = window.CardanoConnectWithWallet;
    const { useState, useEffect } = React;
    // Mock React Native components for a browser environment to avoid errors if not running in RN context
    const View = (props) => <div {...props}>{props.children}</div>;
    const Text = (props) => <span {...props}>{props.children}</span>;
    const TouchableOpacity = (props) => <button {...props}>{props.children}</button>;

    function sendMessageToReactNative(type, payload) {
      console.log('WebView: Sending message to RN:', { type, payload });
      if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
        window.ReactNativeWebView.postMessage(JSON.stringify({ type, payload }));
      } else {
        console.warn('WebView: ReactNativeWebView not found. Not in a WebView context.');
      }
    }

    const WalletConnectorWebComponent = () => {
      const { isConnected, enabledWallet, stakeAddress, disconnect, connect } = useCardano();
      const [webStatus, setWebStatus] = useState("Initializing wallet detector...");

      useEffect(() => {
        console.log('WebView: Wallet connection status changed. isConnected:', isConnected);
        if (isConnected) {
          sendMessageToReactNative('WALLET_CONNECTED', {
            name: enabledWallet?.name,
            stakeAddress: stakeAddress,
          });
          setWebStatus(`Connected to: ${enabledWallet?.name}`);
        } else {
          sendMessageToReactNative('WALLET_DISCONNECTED', null);
          setWebStatus("Disconnected or not yet connected.");
        }
      }, [isConnected, enabledWallet, stakeAddress]);

      useEffect(() => {
        // Initial scan for wallets
        console.log('WebView: Attempting to scan for wallets...');
        const detected = [];
        const knownWallets = ['nami', 'eternl', 'flint', 'lace', 'typhon', 'gero', 'cclv'];

        if (!window.cardano) {
          console.warn('WebView: window.cardano object not found!');
          setWebStatus("No Cardano browser wallets detected. Please install an extension.");
          sendMessageToReactNative('WEBVIEW_STATUS', "No Cardano browser wallets detected.");
        } else {
          for (const walletName of knownWallets) {
            if (window.cardano[walletName] && typeof window.cardano[walletName].enable === 'function') {
              detected.push({
                name: walletName,
                icon: window.cardano[walletName].icon || null,
                version: window.cardano[walletName].version || 'N/A'
              });
            }
          }
          if (detected.length > 0) {
            console.log('WebView: Detected wallets:', detected);
            setWebStatus(`Found ${detected.length} compatible wallets.`);
            sendMessageToReactNative('WEBVIEW_STATUS', `Found ${detected.length} compatible wallets.`);
            sendMessageToReactNative('WALLETS_DETECTED', detected); // Send detected wallets to RN
          } else {
            console.log('WebView: No CIP-30 wallets found on window.cardano.');
            setWebStatus("No CIP-30 wallets found in this browser environment.");
            sendMessageToReactNative('WEBVIEW_STATUS', "No CIP-30 wallets found.");
          }
        }
      }, []); // Run only once on component mount

      const handleConnect = (walletName) => {
        console.log(`WebView: Connect button clicked for ${walletName}!`);
        connect(walletName, () => console.log(`WebView: Successfully connected to ${walletName} callback!`));
      };

      const handleDisconnect = () => {
        console.log('WebView: Disconnect button clicked!');
        disconnect();
      };

      return (
        <View className="flex-1 items-center justify-center p-5">
          <Text className="text-white text-2xl font-bold mb-10 text-center">
            Cardano dApp Connector
          </Text>

          <Text className="text-[#ccc] text-base mb-5 text-center">{webStatus}</Text>

          {isConnected ? (
            <View className="bg-[#28a745] p-5 rounded-lg items-center mt-5 w-11/12 max-w-[400px]">
              <Text className="text-white text-base mb-2 text-center">
                Connected to: {enabledWallet?.name}
              </Text>
              <Text className="text-white text-base mb-2 text-center">
                Stake Address: {stakeAddress}
              </Text>
              <TouchableOpacity className="mt-4 bg-[#ff4444] py-2.5 px-5 rounded" onClick={handleDisconnect}>
                <Text className="text-white font-bold text-base">Disconnect</Text>
              </TouchableOpacity>
            </View>
          ) : (
            <>
              {/* Only show ConnectWalletList if webStatus indicates wallets might be found */}
              {webStatus.includes("Found") || webStatus.includes("Initializing") ? (
                 <ConnectWalletList
                   borderRadius={15}
                   gap={12}
                   primaryColor="#0538AF"
                   onConnect={handleConnect}
                 />
              ) : (
                  <Text className="text-white text-lg text-center mt-5">
                    No compatible wallets detected. Please ensure a wallet extension is installed in this browser.
                  </Text>
              )}
            </>
          )}
        </View>
      );
    };

    ReactDOM.render(<WalletConnectorWebComponent />, document.getElementById('root'));
  </script>
</body>
</html>